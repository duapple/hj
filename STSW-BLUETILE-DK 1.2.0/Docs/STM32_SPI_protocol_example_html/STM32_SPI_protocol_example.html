<!-- HTML header for doxygen 1.8.10-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.10"/>
<title>STM32L - BlueNRG-1,2 network coprocessor (SPI mode): NUCLEO-L152RE STEVAL-IDB007Vx (x=1,2)/STEVAL-IDB008Vx (x=1,2) Network coprocessor HW/SW setup, framework &amp; demo applications</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="STcustom.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="ST-logo-small.jpg"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">STM32L - BlueNRG-1,2 network coprocessor (SPI mode)
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.10 -->
</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">NUCLEO-L152RE STEVAL-IDB007Vx (x=1,2)/STEVAL-IDB008Vx (x=1,2) Network coprocessor HW/SW setup, framework &amp; demo applications </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This document describes an example of the BlueNRG-1,2 network coprocessor SPI protocol implementation on a STM32L1xx microcontroller (NUCLEO-L152RE platform).<br />
 The SPI network coprocessor framework is implementing according to the specification described on SPI protocol specification doxygen documentation.<br />
 The document content is valid for both BlueNRG-1 and BlueNRG-2 devices. Any reference to BlueNRG-1 device is also valid for the BlueNRG-2 device. Any specific difference is highlighted whenever it is needed.<br />
 The BlueNRG-1/BlueNRG-2 device is configured as a network coprocessor (SPI mode).</p>
<h1><a class="anchor" id="U1"></a>
Hardware Platforms</h1>
<ul>
<li>BlueNRG-1 development platforms (order code: STEVAL-IDB007V1, STEVAL-IDB007V2) </li>
<li>BlueNRG-2 development platforms (order code: STEVAL-IDB008V1, STEVAL-IDB007V2) </li>
<li>STM32L152RE Nucleo platform (order code: NUCLEO-L152RE)</li>
</ul>
<ul>
<li>NOTES: <ol>
<li>
When using a NUCLEO-L152RE platform, install the related ST-Link, ST-Link/V2, ST-Link/V2-1 USB driver signed for XP, Windows7, Windows8 (STSW-LINK009). </li>
<li>
When using a NUCLEO-L152RE platform, make sure the ST-Link firmware is updated to latest version available on ST web page. This can be checked/achieved by using the STM32 ST-LINK Utility v3.6.0 (or later). </li>
</ol>
</li>
</ul>
<h1><a class="anchor" id="U2"></a>
Hardware Platforms Prerequisites: connections and HW modifications</h1>
<ul>
<li>The following connections must be performed between the 2 platforms (Nucleo-L152RE &amp; STEVAL-IDB007Vx/STEVAL-IDB008Vx):</li>
</ul>
<table  border="1">
<tr>
<th></th><th>Nucleo-L152RE pin/connector (SPI1) </th><th>STEVAL-IDB007Vx/STEVAL-IDB008Vx pin/connector  </th></tr>
<tr>
<td><b> SPI CLOCK </b> </td><td>PB3/CN10.31/CN9.4 </td><td>IO0 </td></tr>
<tr>
<td><b> SPI MOSI </b> </td><td>PA7/CN10.15/CN5.4 </td><td>IO3  </td></tr>
<tr>
<td><b> SPI MISO </b> </td><td>PA6/CN10.13/CN5.5 </td><td>IO2  </td></tr>
<tr>
<td><b> SPI CS </b> </td><td>PA1/CN7.30/CN8.2 </td><td>IO11 </td></tr>
<tr>
<td><b> SPI IRQ </b> </td><td>PA0/CN7.28/CN8.1 </td><td>IO7 </td></tr>
<tr>
<td><b>BLUENRG-1,2 BOOT (1) </b></td><td>PB14/CN10.28 </td><td>IO7 </td></tr>
<tr>
<td><b>BLUENRG-1,2 RESETN </b> </td><td>PA8/CN10.23/CN9.8 </td><td>RESETN </td></tr>
<tr>
<td><b> VDD </b> </td><td>VDD </td><td>VBLUE </td></tr>
<tr>
<td><b> GND </b> </td><td>GND </td><td>GND </td></tr>
<tr>
</tr>
</table>
<table class="doxtable">
</table>
<p><b> Note (1)</b> : BLUENRG-1,2 BOOT pin to be connected only for bootloader mode.</p>
<ul>
<li>The following HW modifications must be done on the BlueNRG-1,STEVAL-IDB007Vx / BlueNRG-2, STEVAL-IDB008Vx platform in order to use it as Network coprocessor with Nucleo-L152RE: <ol>
<li>
Remove resistor R52. </li>
<li>
Open JP1 jumper. </li>
<li>
JP2 jumper in 1-2 position. </li>
<li>
Make sure resistors R59, R60, R61, R62 are removed on the selected platform.</li>
</ol>
</li>
</ul>
<h1><a class="anchor" id="U3"></a>
Software Prerequisites: SW Configuration</h1>
<ul>
<li>The following SW steps must be performed on the selected BLE platform (BlueNRG-1 STEVAL-IDB007Vx/BlueNRG-2 STEVAL-IDB008Vx): <ul>
<li>
Open the BlueNRG-1 Flasher tool and configure the BlueNRG-1 device a network coprocessor (SPI mode), by loading, respectively, the Firmware\BLE_Examples\BlueNRG-1\DTM\DTM_SPI.hex, Firmware\BLE_Examples\BlueNRG-2\DTM\DTM_SPI.hex binary file on the selected BlueNRG-1, BlueNRG-2 platform. </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="U4"></a>
STM32L1xx  Network coprocessor framework structure</h1>
<table  border="1">
<tr>
<th></th><th>Path </th><th>Description  </th></tr>
<tr>
<td><b> Nucleo-L152RE SDK Drivers </b> </td><td>Library\STM32L\Drivers\BSP\STM32L1xx_Nucleo </td><td>SDK Drivers for NUCLEOE-L152RE Leds, COM, timers </td></tr>
<tr>
<td><b> STM32L1 - BlueNR-1 Nucleo </b> </td><td>Library\STM32L\Drivers\BSP\STM32L1xx_BlueNRG1 </td><td>NUCLEOE-L152RE SPI driver for interfacing to BlueNRG-1,2 network coprocessor  </td></tr>
<tr>
<td><b> STM32L1 CMSIS </b> </td><td>Library\STM32L\Drivers\CMSIS </td><td>CMSIS files for STM32LXXX  </td></tr>
<tr>
<td><b> STM32L1 Cube HAL drivers </b> </td><td>Library\STM32L\Drivers\STM32L1xx_HAL_Driver </td><td>STM32L1xx HAL drivers (Cube framework) </td></tr>
<tr>
<td><b> HAL drivers </b> </td><td>Library\STM32L\Drivers\Middlewares\ST\STM32_BlueNRG1\HAL </td><td>HAL drivers (osal, low power, timers) </td></tr>
<tr>
<td><b> SPI HAL drivers </b> </td><td>Library\STM32L\Drivers\Middlewares\ST\STM32L1xx_HAL_BlueNRG1_Drivers </td><td>SPI middlewares utilities </td></tr>
<tr>
<td><b> ACI framework </b> </td><td>Library\STM32L\Middlewares\ST\STM32_BlueNRG1\SimpleBlueNRG1_HCI </td><td>BLE stack ACI framework APIs for interfacing to the BlueNRG-1,2 BLE stack features and events </td></tr>
<tr>
<td><b> BLE Demonstration application </b> </td><td>Project\STM32L\BLE_Beacon </td><td>BLE Beacon demo application </td></tr>
<tr>
<td><b> BLE Demonstration application </b> </td><td>Project\STM32L\BLE_ChatMasterSlave </td><td>BLE Chat Master/Slave demo application </td></tr>
<tr>
<td><b> BLE Demonstration application </b> </td><td>Project\STM32L\BLE_SensorDemo </td><td>BLE Sensor demo application </td></tr>
<tr>
<td><b> BLE Test application </b> </td><td>Project\STM32L\DTM </td><td>BLE Direct Test Mode application  </td></tr>
</table>
<h1><a class="anchor" id="U5"></a>
Demonstration Applications</h1>
<ul>
<li>The following STM32L - BlueNRG-1,2 network coprocessor (SPI mode) demonstrations application are available (EWARM IAR toolchain 7.70 or later): <ol>
<li>
<b>BLE Beacon </b> application which configures a beacon device: <ul>
<li>
IAR project supporting STM32L152 device (workspace: Release_SPI, Release_LowPower_SPI). </li>
</ul>
</li>
<li>
<b>BLE Chat Master &amp; Slave </b> application which allows to target a BLE Chat application scenario with same binary image:<ul>
<li>
IAR project supporting STM32L152 device (workspace: Release). </li>
</ul>
</li>
<li>
<b> Sensor Demo </b>application with emulated acceleration and environmental sensors values (emulated): <ul>
<li>
IAR project supporting STM32L152 device (workspaces: Release_SPI, Release_LowPower_SPI).</li>
</ul>
</li>
<li>
<b> DTM </b>application to be programmed on STM32L152- NUCLEO L152RE in order to use the BlueNRG GUI tool (file STM32L_Nucleo_DTM_SPI.hex): <ul>
<li>
IAR project supporting STM32L152 device (workspace: DTM_SPI).</li>
</ul>
</li>
</ol>
</li>
</ul>
<ul>
<li>NOTES: <ul>
<li>
Prebuilt binary images are available on \Firmware\STM32L folder </li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="U6"></a>
STM32L1 - Network coprocessor application structure</h1>
<ul>
<li>This section provides the main guidelines to be followed when implementing a STM32L - BlueNRG-1,2 demo application (project structure, main() layout, APP_Tick() layout, event callbacks management).</li>
</ul>
<h2><a class="anchor" id="U61"></a>
Project structure</h2>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_1.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 1: BLE Sensor Demo, Release_SPI configuration example </b>  </td></tr>
</table>
<ul>
<li>Figure 1 shows the project structure of the STM32L-BlueNRG-1,2 BLE Sensor application (Release_SPI workspace). This framework can be taken as reference for implementing any network coprocessor application.</li>
</ul>
<h2><a class="anchor" id="U62"></a>
Application structure: Main function</h2>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_2.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 2: BLE Sensor Demo, main() Function </b>  </td></tr>
</table>
<ul>
<li>Figure 2 shows the application main() structure of the STM32L-BlueNRG-1,2 BLE Sensor application (it's a typical framework which can be taken as reference for any other application with proper customization): <ol>
<li>
Init_Device(): it initializes the STM32L1 device (HAL, clock, ...) and the SPI interface for BlueNRG-1,2 network coprocessor. </li>
<li>
BlueNRG_Stack_Initialization(): it initializes the ACI framework lists and it reset the BlueNRG-1,2 device </li>
<li>
Sensor_DeviceInit(): it calls the BlueNRG-1,2 APIs for configuring the BLE stack (set public address, init GATT and GAP layers, set TX power level, set security settings, add the specific Sensor Demo services and chracteristics, init user timers required for the Sensor Demo application. </li>
<li>
BTLE_StackTick(): BLE stack tick APIs which allows to process the BLE stack events coming from BlueNRG-1,2 BLE stack. </li>
<li>
APP_Tick(): application tick function which implements the application specific state machine. </li>
<li>
System_Sleep(): low power managment API.</li>
</ol>
</li>
</ul>
<ul>
<li>NOTE: The STM32L-BlueNRG-1,2 BLE APIs protoypes are defined on the Library\STM32L\Middlewares\ST\STM32_BlueNRG1\SimpleBlueNRG1_HCI\includes\ folder header files (bluenrg1_gap_aci.h,bluenrg1_gatt_aci.h,bluenrg1_l2cap_aci.h,bluenrg1_hal_aci.h, bluenrg1_hci_le.h,bluenrg1_hal_aci.h).</li>
</ul>
<h2><a class="anchor" id="U63"></a>
Application structure: APP_Tick() function</h2>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_3.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 3: BLE Sensor Demo, APP_Tick() function </b>  </td></tr>
</table>
<ul>
<li>Figure 3 shows the application tick (APP_Tick()) function structure related to the STM32L-BlueNRG-1,2 BLE Sensor application:<ol>
<li>
It checks if application can enter in discoverable mode (Set_DeviceConnectable()) </li>
<li>
<p class="startli">It performs application specific actions:</p><ul>
<li>
Notify the Acceleration characteristic at specific interval. </li>
<li>
If Free Fall conditions is detected, it notified the specific Free Fall characteristic. </li>
</ul>
<p class="endli"></p>
</li>
</ol>
</li>
</ul>
<h2><a class="anchor" id="U64"></a>
Application structure: BLE stack events callbacks</h2>
<table  border="0">
<tr>
<th></th></tr>
<tr>
<td><div class="image">
<img src="Figure_4.png" />
</div>
   </td></tr>
<tr align="center">
<td><b style="font-size: 18px; color:blue;"> Figure 4: BLE Sensor Demo, hci_le_connection_complete_event() callback </b>  </td></tr>
</table>
<ul>
<li>Figure 4 shows the hci_le_connection_complete_event() event callback required from the STM32L-BlueNRG-1,2 BLE Sensor application<ol>
<li>
Each time a specific BLE event is raised from the BlueNRG-1,2 BLE stack the associated BLE stack event callback function is called. </li>
<li>
User is requested to implement ONLY the required BLE events callbacks according to the specific application needs. </li>
<li>
The STM32L-BlueNRG-1,2 BLE events callbacks protoypes are defined on the Library\STM32L\Middlewares\ST\STM32_BlueNRG1\SimpleBlueNRG1_HCI\includes\bluenrg1_events.h header files.</li>
</ol>
</li>
</ul>
<h1><a class="anchor" id="U7"></a>
References</h1>
<ul>
<li>For a detailed description about the SPI protocol implemented over the STM32L1xx platform refer to the available BlueNRG-1,2 network coprocessor (SPI mode) html document. </li>
</ul>
</div></div><!-- contents -->
<!-- HTML footer for doxygen 1.8.10-->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Copyright &copy; 2018 by STMicrolectronics. All rights reserved.<br>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.10
</small></address>
</body>
</html>
